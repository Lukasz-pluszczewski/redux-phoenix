{"version":3,"file":"redux-phoenix.js","sources":["../src/reduxPhoenix.js"],"sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nexport const REHYDRATE = '@@REHYDRATE';\n\n/**\n * transform state according to passed transformation\n *\n * @param {object} map transformation\n * @param {object} state State from redux\n * @return {object} Transformed state\n */\nfunction transform(map, state) {\n  const result = {};\n  _.forEach(map, (value, key) => {\n    if (typeof value === 'function') {\n      const transformation = value(key, _.get(state, key), state);\n      if (transformation.targetKey && _.has(transformation, 'targetValue')) {\n        _.set(result, transformation.targetKey, transformation.targetValue);\n      }\n      if (_.has(transformation, 'sourceValue')) {\n        _.set(result, key, transformation.sourceValue);\n      }\n    } else {\n      _.set(result, value, _.get(state, key));\n    }\n  });\n  return _.merge({}, state, result);\n}\n\n/**\n * Persist store\n *\n * @export\n * @param {object} store Redux Store\n * @param {object} config Configuration object\n * @return {Promise<object>} Persisted Store\n */\nexport default function persistStore(store, {\n  key = 'redux',\n  whitelist = null,\n  blacklist = null,\n  storage = window.localStorage,\n  expireDate = null,\n  serialize = JSON.stringify,\n  deserialize = JSON.parse,\n  map = {},\n  disabled = false,\n  throttle = 0,\n  migrations = null,\n} = {}) {\n  return Promise.resolve(storage.getItem(key)).then(persistedJson => {\n    if (disabled) {\n      return store;\n    }\n    const persistedValue = deserialize(persistedJson);\n    const { persistedState, saveDate } = persistedValue || {};\n    let state = persistedState;\n    if (expireDate && moment(saveDate).add(...expireDate).isBefore(moment())) {\n      state = {};\n    }\n    const persistedStateToMerge = whitelist\n      ? _.omit(_.pick(state, whitelist), blacklist)\n      : _.omit(state, blacklist);\n\n    store.dispatch({\n      type: REHYDRATE,\n      payload: persistedStateToMerge,\n    });\n\n    const saveState = () => {\n      const state = transform(map, store.getState());\n      const subset = whitelist\n        ? _.omit(_.pick(state, whitelist), blacklist)\n        : _.omit(state, blacklist);\n\n      storage.setItem(key, serialize({ persistedState: subset, saveDate: moment().valueOf() }));\n    };\n\n    const throttledSubscribe = _.throttle(saveState, throttle, {\n      trailing: true,\n    });\n    store.subscribe(throttle > 0 ? throttledSubscribe : saveState);\n    return store;\n  });\n}\n\n/**\n * Enhancer\n *\n * @export\n * @param {function} next callback\n * @return {function} enhancer\n */\nexport const autoRehydrate = next => (reducer, initialState, enhancer) => {\n  if (typeof initialState === 'function' && typeof enhancer === 'undefined') {\n    enhancer = initialState;\n    initialState = undefined; // eslint-disable-line no-undefined\n  }\n  function rehydrateReducer(state, action) {\n    if (action.type === REHYDRATE) {\n      return reducer(_.merge({}, state, action.payload), action);\n    }\n    return reducer(state, action);\n  }\n  return next(rehydrateReducer, initialState, enhancer);\n};\n"],"names":["REHYDRATE","transform","map","state","result","_","forEach","value","key","transformation","get","targetKey","has","set","targetValue","sourceValue","merge","persistStore","store","whitelist","blacklist","storage","window","localStorage","expireDate","serialize","JSON","stringify","deserialize","parse","disabled","throttle","migrations","Promise","resolve","getItem","then","persistedJson","persistedValue","persistedState","saveDate","moment","add","isBefore","persistedStateToMerge","omit","pick","dispatch","type","payload","saveState","getState","subset","setItem","valueOf","throttledSubscribe","trailing","subscribe","autoRehydrate","next","reducer","initialState","enhancer","undefined","rehydrateReducer","action"],"mappings":"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"}